<!doctype html>
<html lang="pl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Model Collector ‚Äî DELUXE UltraSafe (Fix)</title>
<style>
:root{--bg:#0f1220;--card:#171a2b;--muted:#9aa3b2;--text:#e6e9f0;--accent:#7c9cff;--ok:#21c7a8;--warn:#ffbf69;--danger:#ff6b6b;--border:#262b45;--shadow:0 6px 24px rgba(0,0,0,.35);--radius:14px}
*{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial;background:radial-gradient(1200px 800px at 20% -10%,#1a1f3a 0,rgba(26,31,58,0) 60%),var(--bg);color:var(--text)}
header{position:sticky;top:0;z-index:20;backdrop-filter:blur(8px);background:linear-gradient(180deg,rgba(15,18,32,.85),rgba(15,18,32,.6));border-bottom:1px solid var(--border)}
.wrap{max-width:1200px;margin:0 auto;padding:16px}
.toolbar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between}
.brand{display:flex;gap:10px;align-items:center;font-weight:700}.logo{width:34px;height:34px;border-radius:10px;background:linear-gradient(135deg,#7c9cff,#21c7a8);display:grid;place-items:center;color:#0b0e1a;font-weight:900}
button,select,input[type="text"],input[type="url"],input[type="password"]{appearance:none;border:1px solid var(--border);background:linear-gradient(180deg,#1a1e33,#121527);color:var(--text);padding:10px 12px;border-radius:12px;box-shadow:var(--shadow);font-weight:600}
button{cursor:pointer;transition:.15s transform ease,.2s border-color} button:hover{transform:translateY(-1px);border-color:#33406a}
button.primary{background:linear-gradient(180deg,#2b3563,#1a2147);border-color:#3a4a86} button.ghost{background:transparent;box-shadow:none}
.btnlink{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:999px;text-decoration:none;color:#cbd3ff;background:#20243a}
.btnlink:hover{transform:translateY(-1px);border-color:#3a4a86}
.layout{display:grid;grid-template-columns:320px 1fr;gap:16px;padding:16px} @media(max-width:900px){.layout{grid-template-columns:1fr}}
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow)}
.row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
.grid{display:grid;gap:16px;grid-template-columns:repeat(3,1fr)} @media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}} @media(max-width:640px){.grid{grid-template-columns:1fr}}
.card{border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;background:linear-gradient(180deg,#171a2b 0,#14182a 100%);box-shadow:var(--shadow);display:flex;flex-direction:column}
.thumb{position:relative;aspect-ratio:4/3;background:#0e1222;overflow:hidden}.thumb img{width:100%;height:100%;object-fit:cover;display:block}
.title{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:12px}.links{display:flex;gap:8px;flex-wrap:wrap;margin:8px 12px}
.meta,.tags{display:flex;gap:8px;flex-wrap:wrap;margin:0 12px 8px 12px}.chip{background:#22263b;color:#cbd3ff;font-size:12px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;cursor:pointer}
.foot{padding:12px;display:flex;gap:8px;border-top:1px solid var(--border);margin-top:auto}
#editor{display:none;margin-top:16px} #editor.open{display:block !important}
#toast{position:fixed;right:12px;bottom:12px;background:#11162a;color:#e6e9f0;border:1px solid var(--border);padding:10px 12px;border-radius:10px;font-size:13px;display:none;z-index:60}
#jsReady{position:fixed;left:12px;bottom:12px;background:#11162a;border:1px solid var(--border);padding:8px 10px;border-radius:8px;font-size:12px;z-index:60}
#cloudOverlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:100}
#cloudOverlay.open{display:flex}
#cloudPanel{width:min(780px,92vw);background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:var(--shadow);padding:16px}
.status{font-size:13px;margin-top:6px}.status.ok{color:#21c7a8} .status.bad{color:#ff6b6b} .status.wait{color:#ffbf69}
.spinner{display:inline-block;width:14px;height:14px;border:2px solid #fff;border-right-color:transparent;border-radius:50%;animation:spin 0.8s linear infinite; vertical-align:-2px; margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.section-title{display:flex;justify-content:space-between;align-items:center}
.section-title h3{margin:8px 0}
</style>
</head>
<body onload="init()">
<div id="jsReady">‚è≥ ≈Åadowanie JS‚Ä¶</div>
<header>
  <div class="wrap toolbar">
    <div class="brand"><div class="logo">MC</div><div><div>Model Collector</div><div class="small">DELUXE UltraSafe (Fix)</div></div></div>
    <div class="flex">
      <button class="primary" onclick="openEditor(null)" type="button">‚ûï Dodaj modelkƒô</button>
      <button onclick="exportJson()" type="button">‚¨áÔ∏è Eksport</button>
      <button onclick="document.getElementById('importFile').click()" type="button">‚¨ÜÔ∏è Import</button>
      <input type="file" id="importFile" accept=".json" onchange="onImport(this)" style="display:none" />
      <button class="ghost" onclick="openCloud()" type="button">‚òÅÔ∏è Chmura</button>
      <button class="ghost" onclick="clearFilters()" type="button">üßπ Wyczy≈õƒá filtry</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div class="layout">
    <aside class="panel" id="filtersPanel">
      <div class="section-title">
        <h2>Filtry</h2>
        <div class="small" id="countInfo">0 pozycji</div>
      </div>

      <div class="row">
        <div><label for="q">Szukaj</label><input id="q" type="text" oninput="onFilter()" placeholder="np. nick" /></div>
        <div><label for="platform">Platforma</label><select id="platform" onchange="onFilter()"><option value="">Dowolna</option><option value="onlyfans">OnlyFans</option><option value="chaturbate">Chaturbate</option><option value="both">Obie</option></select></div>
      </div>

      <div class="row">
        <div><label for="hair">W≈Çosy</label><select id="hair" onchange="onFilter()"><option value="">Dowolne</option><option value="blonde">Blonde</option><option value="brunette">Brunette</option><option value="black">Black</option><option value="redhead">Redhead</option><option value="other">Other</option></select></div>
        <div><label for="body">Sylwetka</label><select id="body" onchange="onFilter()"><option value="">Dowolna</option><option value="slim">Slim</option><option value="fit">Fit</option><option value="curvy">Curvy</option></select></div>
      </div>

      <div class="row">
        <div><label for="eth">Pochodzenie</label><select id="eth" onchange="onFilter()"><option value="">Dowolne</option><option value="latina">Latina</option><option value="asian">Asian</option><option value="other">Other</option></select></div>
        <div>
          <label>Tagi (kliknij, by filtrowaƒá)</label>
          <div id="filterTags" class="chips"></div>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <div class="section-title"><h3>Preset tag√≥w</h3><span class="small">kliknij, by dodaƒá do filtr√≥w</span></div>
        <div id="presetTags" class="chips"></div>
      </div>
    </aside>

    <section>
      <div id="grid" class="grid"></div>
      <div id="empty" class="panel" style="display:none;text-align:center">Brak wynik√≥w</div>

      <div id="editor" class="panel">
        <h2 id="editorTitle">Dodaj / Edytuj modelkƒô</h2>
        <div class="row">
          <div><label>Nazwa / nick</label><input id="f_name" type="text" /></div>
          <div><label>Obraz (URL)</label><input id="f_imgurl" type="url" placeholder="https://..." /></div>
        </div>
        <div class="row">
          <div><label>OnlyFans</label><input id="f_onlyfans" type="url" placeholder="https://onlyfans.com/..." /></div>
          <div><label>Chaturbate</label><input id="f_chaturbate" type="url" placeholder="https://chaturbate.com/..." /></div>
        </div>
        <div class="row">
          <div><label>SimpCity</label><input id="f_simpcity" type="url" placeholder="https://simpcity..." /></div>
          <div><label>Instagram</label><input id="f_insta" type="url" placeholder="https://instagram.com/..." /></div>
        </div>
        <div class="row">
          <div><label>Twitter/X</label><input id="f_twitter" type="url" placeholder="https://twitter.com/..." /></div>
          <div><label>Platforma</label><select id="f_platform"><option value="onlyfans">OnlyFans</option><option value="chaturbate">Chaturbate</option><option value="both">Obie</option></select></div>
        </div>
        <div class="row">
          <div><label>W≈Çosy</label><select id="f_hair"><option value="">‚Äî</option><option value="blonde">Blonde</option><option value="brunette">Brunette</option><option value="black">Black</option><option value="redhead">Redhead</option><option value="other">Other</option></select></div>
          <div><label>Sylwetka</label><select id="f_body"><option value="">‚Äî</option><option value="slim">Slim</option><option value="fit">Fit</option><option value="curvy">Curvy</option></select></div>
        </div>
        <div class="row">
          <div><label>Pochodzenie</label><select id="f_eth"><option value="">‚Äî</option><option value="latina">Latina</option><option value="asian">Asian</option><option value="other">Other</option></select></div>
          <div><label>Tagi (przecinki)</label><input id="f_customtags" type="text" placeholder="pawg, milf, ..." /></div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
          <button class="primary" onclick="onSave()" type="button">üíæ Zapisz</button>
          <button onclick="closeEditor()" type="button">Anuluj</button>
          <div id="saveInfo" class="small"></div>
        </div>
      </div>
    </section>
  </div>
</main>

<div id="cloudOverlay">
  <div id="cloudPanel" class="panel">
    <h3>‚òÅÔ∏è GitHub Sync</h3>
    <div class="row">
      <div><label>Owner</label><input id="ghOwner" type="text" value="notsupas"></div>
      <div><label>Repo</label><input id="ghRepo" type="text" value="some"></div>
    </div>
    <div class="row">
      <div><label>Plik</label><input id="ghPath" type="text" value="models.json"></div>
      <div><label>Branch</label><input id="ghBranch" type="text" value="main"></div>
    </div>
    <div class="row">
      <div><label>Token (PAT)</label><input id="ghToken" type="password" placeholder="ghp_..."></div>
      <div style="display:flex;align-items:center;gap:8px">
        <input id="ghAuto" type="checkbox" onchange="toggleAuto(this)" />
        <label for="ghAuto">Auto-zapis po zmianach</label>
      </div>
    </div>
    <div class="row" style="margin-top:6px">
      <button onclick="cloudSave()" type="button">‚è´ Zapisz teraz</button>
      <button onclick="cloudLoad()" type="button">‚è¨ Pobierz</button>
      <button onclick="closeCloud()" type="button" class="right">Zamknij</button>
    </div>
    <div id="cloudStatus" class="status">Gotowy.</div>
  </div>
</div>

<div id="toast"></div>

<script>
var state={models:[],tags:new Set(['pawg','milf','petite','big ass','cosplay','glasses','riding','blowjob','pawg','milf']),tagSets:{Imported:['pawg','milf','petite','big ass']},filters:{q:'',platform:'',hair:'',body:'',eth:'',tags:new Set()},cloud:{owner:'notsupas',repo:'some',path:'models.json',branch:'main',token:'',auto:false,lastPullUrl:''}};
var pushTimer=null;
var LS_MODELS='mc_models_du_ultra_fix', LS_TAGS='mc_tags_du_ultra_fix', LS_TAGSETS='mc_tagsets_du_ultra_fix', LS_CLOUD='mc_cloud_du_ultra_fix';

function init(){
  var b=document.getElementById('jsReady'); b.textContent='‚úÖ JS dzia≈Ça';
  loadLocal();
  renderFilterTags();
  renderPresetTags();
  applyFilters();
}

function toast(msg){ var t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; setTimeout(function(){t.style.display='none'},2600) }
function saveLocal(){ localStorage.setItem(LS_MODELS, JSON.stringify(state.models)); localStorage.setItem(LS_TAGS, JSON.stringify(Array.from(state.tags))); localStorage.setItem(LS_TAGSETS, JSON.stringify(state.tagSets)); localStorage.setItem(LS_CLOUD, JSON.stringify(state.cloud)); }
function loadLocal(){ try{state.models=JSON.parse(localStorage.getItem(LS_MODELS))||[]}catch(e){} try{state.tags=new Set(JSON.parse(localStorage.getItem(LS_TAGS))||Array.from(state.tags))}catch(e){} try{state.tagSets=JSON.parse(localStorage.getItem(LS_TAGSETS))||state.tagSets}catch(e){} try{Object.assign(state.cloud, JSON.parse(localStorage.getItem(LS_CLOUD))||state.cloud)}catch(e){} }

function placeholder(){return 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='800' height='600'><rect width='100%' height='100%' fill='#14182a'/><text x='50%' y='50%' fill='#6b7392' font-family='Arial' font-size='28' text-anchor='middle' dominant-baseline='middle'>Brak obrazu</text></svg>")}
function chip(text, active){ var s=document.createElement('span'); s.className='chip'+(active?' active':''); s.textContent=text; s.onclick=function(){ if(state.filters.tags.has(text)) state.filters.tags.delete(text); else state.filters.tags.add(text); renderFilterTags(); applyFilters(); }; return s; }
function pill(label, value){ var span=document.createElement('span'); span.className='chip'; span.textContent=label+': '+value; return span; }
function btnLink(href, label){ if(!href) return null; var a=document.createElement('a'); a.className='btnlink'; a.href=href; a.target='_blank'; a.rel='noopener'; a.textContent=label; return a; }

function renderFilterTags(){ var box=document.getElementById('filterTags'); box.innerHTML=''; Array.from(state.tags).sort().forEach(function(t){ box.appendChild(chip(t, state.filters.tags.has(t))); }); }
function renderPresetTags(){
  var preset=['pawg','big ass','milf','petite','riding','blowjob','latina','asian','fit','slim','curvy','blonde','brunette','black','redhead'];
  var box=document.getElementById('presetTags'); box.innerHTML='';
  preset.forEach(function(t){
    var c=chip(t, state.filters.tags.has(t));
    c.onclick=function(){ if(state.tags.has(t)===false) state.tags.add(t); if(state.filters.tags.has(t)) state.filters.tags.delete(t); else state.filters.tags.add(t); renderFilterTags(); renderPresetTags(); applyFilters(); };
    box.appendChild(c);
  });
}

function onFilter(){ state.filters.q=document.getElementById('q').value.toLowerCase(); state.filters.platform=document.getElementById('platform').value; state.filters.hair=document.getElementById('hair').value; state.filters.body=document.getElementById('body').value; state.filters.eth=document.getElementById('eth').value; applyFilters(); }
function clearFilters(){ document.getElementById('q').value=''; document.getElementById('platform').value=''; document.getElementById('hair').value=''; document.getElementById('body').value=''; document.getElementById('eth').value=''; state.filters={q:'',platform:'',hair:'',body:'',eth:'',tags:new Set()}; renderFilterTags(); renderPresetTags(); applyFilters(); }

function applyFilters(){
  var items=state.models.slice(); var f=state.filters;
  if(f.q) items=items.filter(function(m){ return (m.name||'').toLowerCase().indexOf(f.q)>-1 });
  if(f.platform) items=items.filter(function(m){ return m.platform===f.platform || m.platform==='both' });
  if(f.hair) items=items.filter(function(m){ return (m.hair||'')===f.hair });
  if(f.body) items=items.filter(function(m){ return (m.body||'')===f.body });
  if(f.eth) items=items.filter(function(m){ return (m.eth||'')===f.eth });
  if(f.tags.size) items=items.filter(function(m){ var t=new Set(m.tags||[]); var ok=true; state.filters.tags.forEach(function(x){ if(!t.has(x)) ok=false; }); return ok; });
  renderGrid(items);
}

function renderGrid(items){
  var grid=document.getElementById('grid'), empty=document.getElementById('empty'); grid.innerHTML='';
  document.getElementById('countInfo').textContent=items.length+' '+(items.length===1?'pozycja':'pozycji');
  empty.style.display=items.length?'none':'block';
  items.forEach(function(m){
    var card=document.createElement('div'); card.className='card';
    var th=document.createElement('div'); th.className='thumb';
    var img=document.createElement('img'); img.src=m.image||placeholder(); img.alt=m.name||'‚Äî'; img.loading='lazy'; th.appendChild(img);
    var title=document.createElement('div'); title.className='title';
    var h3=document.createElement('h3'); h3.style.margin='0'; h3.textContent=m.name||'‚Äî';
    var plat=document.createElement('span'); plat.className='chip'; plat.textContent=(m.platform==='both'?'OF+CB':(m.platform||'‚Äî'));
    title.appendChild(h3); title.appendChild(plat);
    var meta=document.createElement('div'); meta.className='meta';
    if(m.hair) meta.appendChild(pill('Hair', m.hair)); if(m.body) meta.appendChild(pill('Body', m.body)); if(m.eth) meta.appendChild(pill('Origin', m.eth));
    var links=document.createElement('div'); links.className='links';
    [ ['OnlyFans',m.onlyfans], ['Chaturbate',m.chaturbate], ['SimpCity',m.simpcity], ['Instagram',m.insta], ['Twitter/X',m.twitter] ].forEach(function(p){ var a=btnLink(p[1],p[0]); if(a) links.appendChild(a); });
    var tags=document.createElement('div'); tags.className='tags'; (m.tags||[]).forEach(function(t){ tags.appendChild(chip(t,false)); });
    var foot=document.createElement('div'); foot.className='foot';
    var ed=document.createElement('button'); ed.textContent='‚úèÔ∏è Edytuj'; ed.onclick=function(){ console.log('edit clicked for id=', m.id); openEditor(m.id); };
    var del=document.createElement('button'); del.textContent='üóëÔ∏è Usu≈Ñ'; del.onclick=function(){ removeModel(m.id) };
    foot.appendChild(ed); foot.appendChild(del);
    card.appendChild(th); card.appendChild(title); card.appendChild(meta); card.appendChild(links); card.appendChild(tags); card.appendChild(foot);
    grid.appendChild(card);
  });
}

// --- Editor ---
function openEditor(id){
  console.log('openEditor clicked; id=', id);
  state.editId=id||null;
  var ed=document.getElementById('editor');
  ed.classList.add('open');
  ed.style.display='block'; // hard fallback
  document.getElementById('editorTitle').textContent=id?'Edytuj modelkƒô':'Dodaj modelkƒô';
  document.getElementById('saveInfo').textContent='';
  var m=null; if(id){ for(var i=0;i<state.models.length;i++){ if(state.models[i].id===id){ m=state.models[i]; break; } } }
  document.getElementById('f_name').value=(m&&m.name)||'';
  document.getElementById('f_imgurl').value=(m&&m.image)||'';
  document.getElementById('f_onlyfans').value=(m&&m.onlyfans)||'';
  document.getElementById('f_chaturbate').value=(m&&m.chaturbate)||'';
  document.getElementById('f_simpcity').value=(m&&m.simpcity)||'';
  document.getElementById('f_insta').value=(m&&m.insta)||'';
  document.getElementById('f_twitter').value=(m&&m.twitter)||'';
  document.getElementById('f_platform').value=(m&&m.platform)||'onlyfans';
  document.getElementById('f_hair').value=(m&&m.hair)||'';
  document.getElementById('f_body').value=(m&&m.body)||'';
  document.getElementById('f_eth').value=(m&&m.eth)||'';
  document.getElementById('f_customtags').value=((m&&m.tags)||[]).join(', ');
  window.scrollTo(0,0);
}
function closeEditor(){ var ed=document.getElementById('editor'); ed.classList.remove('open'); ed.style.display='none'; }
function parseTags(s){ return (s||'').split(',').map(function(x){return x.trim()}).filter(Boolean) }
function onSave(){
  var p={ name:document.getElementById('f_name').value.trim(), image:document.getElementById('f_imgurl').value.trim(), onlyfans:document.getElementById('f_onlyfans').value.trim(), chaturbate:document.getElementById('f_chaturbate').value.trim(), simpcity:document.getElementById('f_simpcity').value.trim(), insta:document.getElementById('f_insta').value.trim(), twitter:document.getElementById('f_twitter').value.trim(), hair:document.getElementById('f_hair').value, body:document.getElementById('f_body').value, eth:document.getElementById('f_eth').value, platform:document.getElementById('f_platform').value, tags:parseTags(document.getElementById('f_customtags').value), createdAt:Date.now() };
  if(!p.name){ toast('Podaj nazwƒô'); return; }
  p.tags.forEach(function(t){ state.tags.add(t) });
  if(state.editId){ for(var i=0;i<state.models.length;i++){ if(state.models[i].id===state.editId){ state.models[i]=Object.assign({}, state.models[i], p); break; } } } else { p.id='id-'+Date.now()+'-'+Math.random().toString(16).slice(2); state.models.unshift(p); }
  saveLocal(); document.getElementById('saveInfo').textContent='Zapisano ‚úÖ'; closeEditor(); renderFilterTags(); renderPresetTags(); applyFilters(); if(state.cloud.auto) scheduleCloudPush();
}

// --- CRUD helpers ---
function removeModel(id){ if(!confirm('UsunƒÖƒá tƒô pozycjƒô?')) return; state.models=state.models.filter(function(m){return m.id!==id}); saveLocal(); applyFilters(); toast('Usuniƒôto ‚úÖ'); if(state.cloud.auto) scheduleCloudPush(); }
function exportJson(){ var data={models:state.models, tags:Array.from(state.tags), tagSets:state.tagSets, sort:{key:'created',dir:'desc'}, view:'grid'}; var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); var url=URL.createObjectURL(blob); var a=document.createElement('a'); a.href=url; a.download='models.json'; a.click(); setTimeout(function(){URL.revokeObjectURL(url)},1500); }
function onImport(input){ var f=input.files[0]; if(!f) return; var r=new FileReader(); r.onload=function(){ try{ var j=JSON.parse(r.result); if(Array.isArray(j.models)) state.models=j.models; if(Array.isArray(j.tags)) state.tags=new Set(j.tags); if(j.tagSets) state.tagSets=j.tagSets; saveLocal(); renderFilterTags(); renderPresetTags(); applyFilters(); toast('Zaimportowano ‚úÖ'); if(state.cloud.auto) scheduleCloudPush(); }catch(e){ toast('B≈ÇƒÖd importu') } }; r.readAsText(f); input.value=''; }

// --- Cloud (unchanged) ---
function openCloud(){ document.getElementById('ghOwner').value=state.cloud.owner||'notsupas'; document.getElementById('ghRepo').value=state.cloud.repo||'some'; document.getElementById('ghPath').value=state.cloud.path||'models.json'; document.getElementById('ghBranch').value=state.cloud.branch||'main'; document.getElementById('ghToken').value=state.cloud.token||''; document.getElementById('ghAuto').checked=!!state.cloud.auto; document.getElementById('cloudStatus').textContent='Gotowy.'; document.getElementById('cloudOverlay').classList.add('open'); }
function closeCloud(){ document.getElementById('cloudOverlay').classList.remove('open'); }
function toggleAuto(cb){ state.cloud.auto=!!cb.checked; saveLocal(); if(state.cloud.auto) scheduleCloudPush(); }
function b64(s){ return btoa(unescape(encodeURIComponent(s))) }
async function getSha(owner,repo,path,branch,token){ var url='https://api.github.com/repos/'+owner+'/'+repo+'/contents/'+encodeURIComponent(path)+'?ref='+encodeURIComponent(branch); var headers={'Accept':'application/vnd.github+json'}; if(token) headers['Authorization']='token '+token; var r=await fetch(url,{headers:headers}); if(r.status===404) return null; if(!r.ok) throw new Error('getSha HTTP '+r.status); var j=await r.json(); return j.sha; }
async function verifyReadback(owner,repo,path,branch){ var url='https://raw.githubusercontent.com/'+owner+'/'+repo+'/'+branch+'/'+path; try{ var res=await fetch(url+'?t='+(Date.now())); var text=await res.text(); try{ var j=JSON.parse(text); document.getElementById('cloudStatus').innerHTML='<span class="status ok">‚úÖ Zapis potwierdzony ‚Äî '+(Array.isArray(j.models)?j.models.length:0)+' modeli</span> <a class="small" target="_blank" rel="noopener" href="'+url+'">(podglƒÖd JSON)</a>'; return true; }catch(e){ document.getElementById('cloudStatus').innerHTML='<span class="status bad">‚ö†Ô∏è RAW nie jest JSON</span> <a class="small" target="_blank" rel="noopener" href="'+url+'">(otw√≥rz)</a>'; return false; } }catch(e){ document.getElementById('cloudStatus').textContent='‚ùå Nie uda≈Ço siƒô potwierdziƒá odczytu: '+e.message; document.getElementById('cloudStatus').className='status bad'; return false; } }
async function cloudSave(){ var owner=document.getElementById('ghOwner').value.trim()||state.cloud.owner, repo=document.getElementById('ghRepo').value.trim()||state.cloud.repo, path=document.getElementById('ghPath').value.trim()||state.cloud.path||'models.json', branch=document.getElementById('ghBranch').value.trim()||state.cloud.branch||'main', token=document.getElementById('ghToken').value.trim()||state.cloud.token; if(!owner||!repo||!path||!branch||!token){ document.getElementById('cloudStatus').textContent='Uzupe≈Çnij owner/repo/path/branch/token'; document.getElementById('cloudStatus').className='status bad'; return; } if(state.models.length===0){ if(!confirm('Masz 0 modeli. Zapis do GitHuba wyczy≈õci models.json. Kontynuowaƒá?')){ document.getElementById('cloudStatus').textContent='Anulowano ‚Äî brak danych do zapisu'; document.getElementById('cloudStatus').className='status bad'; return; } } state.cloud={owner:owner,repo:repo,path:path,branch:branch,token:token,auto:document.getElementById('ghAuto').checked,lastPullUrl:'https://raw.githubusercontent.com/'+owner+'/'+repo+'/'+branch+'/'+path}; saveLocal(); var st=document.getElementById('cloudStatus'); st.innerHTML='<span class="spinner"></span><span class="status wait">Wysy≈Çam commit‚Ä¶</span>'; try{ var api='https://api.github.com/repos/'+owner+'/'+repo+'/contents/'+encodeURIComponent(path); var headers={'Accept':'application/vnd.github+json','Content-Type':'application/json','Authorization':'token '+token}; var data={models:state.models, tags:Array.from(state.tags), tagSets:state.tagSets, sort:{key:'created',dir:'desc'}, view:'grid'}; var contentStr=JSON.stringify(data,null,2); async function tryPut(){ var sha=await getSha(owner,repo,path,branch,token); var body={message:'MC deluxe-ultra-fix autosave', content:b64(contentStr), branch:branch, sha: sha || undefined}; return fetch(api,{method:'PUT',headers:headers,body:JSON.stringify(body)}); } var res=await tryPut(); if(res.status===409){ res=await tryPut(); } var text=await res.text(); if(!res.ok){ st.innerHTML='<span class="status bad">‚ùå B≈ÇƒÖd HTTP '+res.status+'</span><div class="small">'+text.replace(/</g,'&lt;')+'</div>'; return; } st.innerHTML='<span class="spinner"></span><span class="status wait">Zapis OK ‚Äî weryfikujƒô‚Ä¶</span>'; var ok=await verifyReadback(owner,repo,path,branch); if(ok) setTimeout(function(){ closeCloud(); }, 900); }catch(e){ st.textContent='‚ùå WyjƒÖtek: '+e.message; st.className='status bad'; } }
async function cloudLoad(){ var owner=document.getElementById('ghOwner').value.trim()||state.cloud.owner, repo=document.getElementById('ghRepo').value.trim()||state.cloud.repo, path=document.getElementById('ghPath').value.trim()||state.cloud.path||'models.json', branch=document.getElementById('ghBranch').value.trim()||state.cloud.branch||'main'; var url='https://raw.githubusercontent.com/'+owner+'/'+repo+'/'+branch+'/'+path; var st=document.getElementById('cloudStatus'); st.innerHTML='<span class="spinner"></span><span class="status wait">Pobieram‚Ä¶</span>'; try{ var res=await fetch(url+'?t='+(Date.now())); var j=await res.json(); if(Array.isArray(j.models)){ state.models=j.models; if(Array.isArray(j.tags)) state.tags=new Set(j.tags); if(j.tagSets) state.tagSets=j.tagSets; saveLocal(); renderFilterTags(); renderPresetTags(); applyFilters(); st.innerHTML='<span class="status ok">‚úÖ Pobrano '+j.models.length+' modeli</span> <a class="small" target="_blank" rel="noopener" href="'+url+'">(podglƒÖd JSON)</a>'; } else { st.textContent='Plik nie zawiera pola models'; st.className='status bad'; } }catch(e){ st.textContent='‚ùå Nie uda≈Ço siƒô pobraƒá: '+e.message; st.className='status bad'; } }
function scheduleCloudPush(){ if(!state.cloud.auto) return; if(pushTimer) clearTimeout(pushTimer); pushTimer=setTimeout(function(){ cloudSave(); },1500); }
</script>
</body>
</html>
